@using StudentInfo.Interfaces.IRepositories
@using StudentInfo.Model
@using StudentInfo.Model.DTOs
@using StudentInfo.Pages.Department
@using Radzen.Blazor;
@inject Radzen.DialogService dialogService
@inject IBaseRepository<Faculty> FacultyRepository
@inject IBaseRepository<Department> departmentRepository

<PageTitle>Edit Faculty</PageTitle>

  <RadzenColumn SizeMD=12>
    <RadzenAlert Shade="Shade.Lighter" Variant="Variant.Flat" Size="AlertSize.Small" AlertStyle="AlertStyle.Danger" Visible="@errorVisible">Cannot save Faculty</RadzenAlert>
    <RadzenTemplateForm TItem="StudentInfo.Model.Faculty" Data="@faculty" Visible="@(faculty != null)" Submit="@FormSubmit">

        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Name" Component="Name" style="width: 100%" />
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenTextBox style="display: block; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" @bind-Value="@faculty.Name" Name="Name" />
                <RadzenRequiredValidator Component="Name" Text="Name is required" />
            </RadzenColumn>
        </RadzenRow>

        <RadzenRow style="margin-bottom: 1rem">
            <RadzenColumn SizeMD="3">
                <RadzenLabel Text="Note" Component="Note" style="width: 100%" />
            </RadzenColumn>
            <RadzenColumn SizeMD="9">
                <RadzenTextBox style="display: block; width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" @bind-Value="@faculty.Note" Name="Note" />
            </RadzenColumn>
        </RadzenRow>

        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="0.5rem " Style="padding: 5px">
            <RadzenButton ButtonStyle="ButtonStyle.Info" Text="Add Department" Variant="Variant.Flat" Click="@AddDepartmantButtonClick" />
        </RadzenStack>

        @if (departments.Count() != 0)
        {
            <RadzenFieldset Text="Departments:">
                <ul>
                    @foreach (var departmentModel in listNewDepartments)
                    {
                        <li>
                            <div class="row">
                                <div class="col col-9">
                                    @departmentModel.Name
                                </div>
                                <div class="col col-3">
                                    <RadzenButton ButtonStyle="ButtonStyle.Danger" Size="ButtonSize.Small" Click="() => EditDepartment(departmentModel)">
                                        <span class="oi oi-x" aria-hidden="true"></span>
                                    </RadzenButton>
                                </div>
                            </div>
                        </li>
                    }
                </ul>
            </RadzenFieldset>
        }
        <RadzenStack Orientation="Orientation.Horizontal" AlignItems="AlignItems.Center" JustifyContent="JustifyContent.Center" Gap="0.5rem">
            <RadzenButton ButtonStyle="ButtonStyle.Light" Text="Cancel" Variant="Variant.Flat" Click="@CancelButtonClick" />
            <RadzenButton ButtonStyle="ButtonStyle.Primary" ButtonType="ButtonType.Submit" Icon="save" Text="Save" Variant="Variant.Flat" />
        </RadzenStack>
    </RadzenTemplateForm>
</RadzenColumn>
@code {
    [Parameter] public int Id { get; set; }
    private List<Department> departments;
    // private List<DepartmentCreate> originDepartments;
    private List<DepartmentCreate> listNewDepartments = new List<DepartmentCreate>();

    protected override async Task OnInitializedAsync()
    {
        faculty = FacultyRepository.GetElementById(Id);
        departments = departmentRepository.GetAllElements().Where(d => d.FacultyId == Id).ToList();
        foreach(var i in departments)
        {
            DepartmentCreate dep = new DepartmentCreate
            {
                Name = i.Name
            };
            await NewDepartment(dep);
        }
    }

    // private void RefreshTable()
    // {
    //     faculty = FacultyRepository.GetElementById(Id);
    //     departments = departmentRepository.GetAllElements().Where(d => d.FacultyId == Id).ToList();
    //     StateHasChanged();
    // }

    protected bool errorVisible;
    protected Faculty faculty;

    protected async Task FormSubmit()
    {
        try
        {

            FacultyRepository.UpdateElement(Id, faculty);
            await CleaningDB();
            foreach(var i in listNewDepartments)
            {
                await AddNewDepartment(i);
            }
            dialogService.Close(faculty);
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorVisible = true;
        }
    }

    protected async Task CancelButtonClick(MouseEventArgs args)
    {
        dialogService.Close(null);
        // RefreshTable();
    }

    protected async Task AddNewDepartment(DepartmentCreate departmantCreate)
    {
        Department obj = new Department
                {
                    Name = departmantCreate.Name,
                    FacultyId = Id
                };

        departmentRepository.CreateElement(obj);
    }


    protected async Task RemoveDepartment(DepartmentCreate departmantRemove)
    {
        listNewDepartments.Remove(departmantRemove);
        // RefreshTable();
    }

    protected async Task CleaningDB()
    {
        foreach(var dep in departments)
        {
            departmentRepository.DeleteElement(dep.DepartmentId);
        }
    }

    protected async Task AddDepartmantButtonClick(MouseEventArgs args)
    {

        await dialogService.OpenAsync("Add Department", ds => @<AddDepartment OnDepartmentCreated="NewDepartment" />,
        new DialogOptions() { Width = "300px", Height = "300px", Resizable = false, Draggable = false });
    }


    protected async Task EditDepartment(DepartmentCreate departmentToEdit)
    {
        await RemoveDepartment(departmentToEdit);
        await dialogService.OpenAsync("Edit Department", ds => @<EditDepartment  
                                                                    DepartmentUpdate="departmentToEdit" 
                                                                    OnDepartmentEdit="NewDepartment" 
                                                                    OnDepartmentRemove="RemoveDepartment"/>
    ,
        new DialogOptions() { Width = "300px", Height = "300px", Resizable = false, Draggable = false });
    }

    protected async Task NewDepartment(DepartmentCreate department)
    {
        listNewDepartments.Add(department);
    }
}

